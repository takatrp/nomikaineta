<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>巡回監査チェックリスト（スマホ用）</title>
  <style>
    :root{
      --bg:#f7f7f8;--card:#ffffff;--ink:#1f2937;--muted:#6b7280;--ok:#16a34a;--ng:#dc2626;--na:#6b7280;--pri:#2563eb;--line:#e5e7eb;--warn:#f59e0b;
    }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP","Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:820px;margin:0 auto;padding:12px 12px 88px;}
    header{position:sticky;top:0;background:var(--bg);padding:8px 12px;border-bottom:1px solid var(--line);z-index:10;}
    h1{font-size:18px;margin:4px 0 8px;}
    .grid{display:grid;gap:8px;}
    .g2{grid-template-columns:1fr 1fr;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;}
    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
    input[type="text"],input[type="date"],select,textarea{width:100%;padding:12px 12px;border:1px solid var(--line);border-radius:10px;background:white;font-size:16px;}
    textarea{min-height:72px;}
    .toolbar{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.96);backdrop-filter:saturate(180%) blur(8px);border-top:1px solid var(--line);padding:10px;display:flex;gap:8px;z-index:20;}
    .toolbar button{flex:1;padding:12px;border-radius:12px;border:1px solid var(--line);font-size:15px;background:var(--card);}    
    .toolbar button.primary{background:var(--pri);border-color:var(--pri);color:#fff;}
    .toolbar button.warn{background:#fff8eb;border-color:#ffe3b3;color:#7a5200;}
    .sec-title{display:flex;align-items:center;justify-content:space-between;margin:16px 0 8px;}
    .sec-title h2{font-size:16px;margin:0;}
    .pill{font-size:12px;color:var(--muted);}    
    .item{border:1px solid var(--line);border-radius:12px;padding:10px;margin:8px 0;background:#fff;}
    .item-top{display:flex;gap:10px;align-items:center;}
    .item-title{flex:1;font-size:15px;}
    .seg{display:inline-grid;grid-auto-flow:column;border:1px solid var(--line);border-radius:999px;overflow:hidden;}
    .seg input{display:none;}
    .seg label{padding:8px 10px;font-size:13px;cursor:pointer;}
    .seg input:checked + label{background:#eef2ff;color:#1e40af;font-weight:600;}
    .seg .ok input:checked + label{background:#ecfdf5;color:#065f46;}
    .seg .ng input:checked + label{background:#fef2f2;color:#7f1d1d;}
    .note{margin-top:8px;}
    .help{margin-top:6px;color:var(--muted);font-size:12px;}
    .req{font-size:12px;color:var(--ng);margin-top:4px;display:none;}
    .req.show{display:block;}
    .muted{color:var(--muted);}
    .progress{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden;}
    .progress > div{height:100%;background:var(--pri);width:0;transition:width .2s;}
    .chips{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted);}
    .chip{padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;}
    .stat{display:flex;gap:8px;}
    .stat b{font-size:15px;}
    .sig-pad{border:1px dashed var(--line);border-radius:8px;height:120px;background:#fff;touch-action:none;}
    .thumbs{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
    .thumbs img{width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--line);}
    .danger{color:var(--ng)}
    @media print{
      .toolbar, header{display:none !important}
      body{background:#fff;}
      .wrap{padding:0;}
      .item{page-break-inside:avoid}
    }
  </style>
</head>
<body>
  <header>
    <h1>巡回監査チェックリスト</h1>
    <div class="grid g2">
      <div class="card">
        <label class="small">顧問先（必須）</label>
        <input id="client" type="text" placeholder="例）ABC株式会社"/>
      </div>
      <div class="card">
        <label class="small">監査日</label>
        <input id="visitDate" type="date"/>
      </div>
      <div class="card">
        <label class="small">担当者</label>
        <input id="auditor" type="text" placeholder="担当者名"/>
      </div>
      <div class="card">
        <label class="small">バージョン／進捗</label>
        <div class="chips"><span class="chip" id="templateVer">v1</span>
          <div class="progress" style="flex:1"><div id="progbar"></div></div>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap" id="app">
    <div class="card" style="margin-top:12px">
      <div class="stat">
        <span class="muted">回答数:</span><b id="answered">0</b>/<span id="total">0</span>
        <span class="muted" style="margin-left:8px">OK:</span><b id="cntOK">0</b>
        <span class="muted">NG:</span><b id="cntNG" class="danger">0</b>
        <span class="muted">N/A:</span><b id="cntNA">0</b>
      </div>
    </div>

    <div id="sections"></div>

    <div class="card">
      <label class="small">監査メモ（全体）</label>
      <textarea id="globalNote" placeholder="所感・要改善点・次回アクションなど"></textarea>
    </div>

    <div class="card">
      <label class="small">署名（顧問先担当者）</label>
      <canvas id="sig" class="sig-pad"></canvas>
      <div class="chips" style="margin-top:8px">
        <button id="sigClear" type="button">署名クリア</button>
      </div>
    </div>

    <details class="card">
      <summary>テンプレート編集（上級者向け）</summary>
      <p class="muted">JSONを編集してチェック項目をカスタマイズできます。編集後は「テンプレート読込」。</p>
      <textarea id="tplEditor" style="min-height:200px"></textarea>
      <div class="chips" style="margin-top:8px">
        <button id="tplLoad">テンプレート読込</button>
        <button id="tplExport">テンプレート書出</button>
        <button id="tplReset" class="warn">初期化</button>
      </div>
    </details>
  </div>

  <div class="toolbar">
    <button id="save">下書き保存</button>
    <button id="export" class="primary">JSON書出</button>
    <button id="csv">CSV書出</button>
    <button id="print" class="warn">PDF印刷</button>
    <button id="reset" class="" style="flex:0 0 auto">リセット</button>
  </div>

<script>
// ====== 1) 初期テンプレート（自由に編集可） ======
const DEFAULT_TEMPLATE = [
  {section:"基本確認", items:[
    {id:"policy", label:"会計方針・運用ルールの変更有無を確認", help:"変更があれば記録・承認文書を保存", requireNoteIf:"NG"},
    {id:"backup", label:"会計データのバックアップ運用を確認", help:"自動/手動の頻度・保管先・復元テスト", requireNoteIf:"NG"},
  ]},
  {section:"会計記録", items:[
    {id:"voucher", label:"証憑（請求書・領収書・契約書）保存状況", help:"電子帳簿保存法の要件確認（スキャナ保存/電子取引）", requireNoteIf:"NG"},
    {id:"books", label:"月次仕訳の記帳遅延の有無", help:"未計上や仮勘定の棚上げを点検", requireNoteIf:"NG"},
    {id:"recon", label:"預金残高の通帳突合・現金実査", help:"差異は原因と処理を記録", requireNoteIf:"NG"}
  ]},
  {section:"売上・入金", items:[
    {id:"sales-docs", label:"請求書控え・売上計上基準の妥当性", help:"検収/出荷/役務完了などの基準", requireNoteIf:"NG"},
    {id:"ar", label:"入金消込と売掛金年齢表の確認", help:"滞留債権の要管理・貸倒可能性", requireNoteIf:"NG"}
  ]},
  {section:"仕入・経費・支払", items:[
    {id:"ap", label:"支払承認フロー・証憑と支払の突合", help:"権限者の承認印跡など", requireNoteIf:"NG"},
    {id:"tax", label:"消費税区分の誤り有無（課/非/免・軽減）", help:"不課税・対象外の混同に注意", requireNoteIf:"NG"}
  ]},
  {section:"人事・労務", items:[
    {id:"payroll", label:"給与計算の根拠資料・社会保険/源泉税の適正", help:"入退社手続・マイナンバー管理", requireNoteIf:"NG"}
  ]},
  {section:"経営管理", items:[
    {id:"budget", label:"予実管理の実施（限界利益・固定費の把握）", help:"目標・KPI・差異分析", requireNoteIf:"NG"},
    {id:"action", label:"前回指摘事項の是正状況", help:"未完了の改善アクションを洗い出し", requireNoteIf:"NG"}
  ]},
];

// ====== 2) 状態 ======
let TEMPLATE = JSON.parse(localStorage.getItem('巡回監査:TEMPLATE')||'null') || DEFAULT_TEMPLATE;
const state = {answers:{}, notes:{}, photos:{}, meta:{client:"",visitDate:"",auditor:"",globalNote:"",signature:""}};

// ====== 3) 要素取得 ======
const el = id=>document.getElementById(id);
const sectionsEl = el('sections');

// ====== 4) UI構築 ======
function render(){
  sectionsEl.innerHTML='';
  const totalItems = TEMPLATE.reduce((s,sec)=>s+sec.items.length,0);
  el('total').textContent = totalItems;

  TEMPLATE.forEach((sec,si)=>{
    const secBox = document.createElement('section');
    const title = document.createElement('div');
    title.className='sec-title';
    title.innerHTML = `<h2>${si+1}. ${sec.section}</h2><span class="pill">${(state.meta.client||'—')}</span>`;
    sectionsEl.appendChild(title);

    sec.items.forEach(item=>{
      const box = document.createElement('div');
      box.className='item';
      box.dataset.itemId=item.id;
      box.innerHTML = `
        <div class="item-top">
          <div class="item-title">${item.label}</div>
          <div class="seg">
            <span class="ok"><input type="radio" name="${item.id}" id="${item.id}_ok" value="OK"><label for="${item.id}_ok">OK</label></span>
            <span class="ng"><input type="radio" name="${item.id}" id="${item.id}_ng" value="NG"><label for="${item.id}_ng">NG</label></span>
            <span class="na"><input type="radio" name="${item.id}" id="${item.id}_na" value="NA"><label for="${item.id}_na">N/A</label></span>
          </div>
        </div>
        ${item.help?`<div class="help">${item.help}</div>`:''}
        <div class="note"><textarea placeholder="メモ（必要に応じて記入）" data-note="${item.id}"></textarea></div>
        <div class="chips" style="margin-top:6px">
          <label class="small">写真添付<input type="file" accept="image/*" capture="environment" data-photo="${item.id}" multiple></label>
        </div>
        <div class="thumbs" data-thumbs="${item.id}"></div>
        <div class="req" id="req_${item.id}">NG 選択時はメモ（および可能なら写真）が必須です</div>
      `;
      sectionsEl.appendChild(box);
    });
  });

  // 既存データを復元
  Object.entries(state.answers).forEach(([id,val])=>{
    const r = document.querySelector(`input[name="${id}"][value="${val}"]`);
    if(r) r.checked = true;
  });
  Object.entries(state.notes).forEach(([id,txt])=>{
    const t = document.querySelector(`textarea[data-note="${id}"]`);
    if(t) t.value = txt;
  });
  Object.entries(state.photos).forEach(([id,arr])=>{
    const holder = document.querySelector(`[data-thumbs="${id}"]`);
    if(holder){
      arr.forEach(src=>{
        const img = new Image();img.src=src;holder.appendChild(img);
      });
    }
  });

  updateStats();
  el('tplEditor').value = JSON.stringify(TEMPLATE, null, 2);
}

// ====== 5) 入力ハンドラ ======
sectionsEl.addEventListener('change', (e)=>{
  const t=e.target;
  // 1) ラジオ（OK/NG/NA）
  if(t.name && (t.type==='radio')){
    state.answers[t.name]=t.value;  
    validateItem(t.name);
    saveDraft(false);
    updateStats();
  }
  // 2) メモ
  if(t.dataset && t.dataset.note){
    state.notes[t.dataset.note]=t.value;
    validateItem(t.dataset.note);
    saveDraft(false);
  }
  // 3) 写真
  if(t.dataset && t.dataset.photo){
    const id = t.dataset.photo;
    state.photos[id]=state.photos[id]||[];
    const holder = document.querySelector(`[data-thumbs="${id}"]`);
    for(const file of t.files){
      const reader = new FileReader();
      reader.onload = ev => {
        state.photos[id].push(ev.target.result);
        const img = new Image();img.src=ev.target.result;holder.appendChild(img);
        saveDraft(false);
      };
      reader.readAsDataURL(file);
    }
  }
});

function validateItem(id){
  const need = state.answers[id]==='NG';
  const note = (state.notes[id]||'').trim();
  const photos = (state.photos[id]||[]);
  const ok = !need || (note.length>0);
  document.getElementById('req_'+id)?.classList.toggle('show', !ok);
}

function updateStats(){
  const ids = TEMPLATE.flatMap(s=>s.items.map(i=>i.id));
  const answered = ids.filter(id=>['OK','NG','NA'].includes(state.answers[id])).length;
  const ok = ids.filter(id=>state.answers[id]==='OK').length;
  const ng = ids.filter(id=>state.answers[id]==='NG').length;
  const na = ids.filter(id=>state.answers[id]==='NA').length;
  el('answered').textContent = answered; el('cntOK').textContent=ok; el('cntNG').textContent=ng; el('cntNA').textContent=na;
  el('progbar').style.width = (answered/ids.length*100)+'%';
}

// ====== 6) 署名 ======
(function setupSig(){
  const cvs = el('sig');
  const ctx = cvs.getContext('2d');
  function resize(){cvs.width = cvs.clientWidth; cvs.height = cvs.clientHeight; drawFromState();}
  window.addEventListener('resize', resize, {passive:true});
  resize();
  let drawing=false, last=null;
  const pos = e=>{
    const r=cvs.getBoundingClientRect();
    const x = (e.touches?e.touches[0].clientX:e.clientX)-r.left;
    const y = (e.touches?e.touches[0].clientY:e.clientY)-r.top;
    return {x,y};
  }
  function line(a,b){
    ctx.lineWidth=2;ctx.lineCap='round';ctx.strokeStyle='#111827';
    ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke();
  }
  function start(e){drawing=true; last=pos(e);} 
  function move(e){ if(!drawing) return; const p=pos(e); line(last,p); last=p; state.meta.signature=cvs.toDataURL('image/png'); }
  function end(){drawing=false;}
  cvs.addEventListener('mousedown',start);cvs.addEventListener('mousemove',move);window.addEventListener('mouseup',end);
  cvs.addEventListener('touchstart',start,{passive:true});cvs.addEventListener('touchmove',move,{passive:true});window.addEventListener('touchend',end);
  el('sigClear').addEventListener('click',()=>{ctx.clearRect(0,0,cvs.width,cvs.height); state.meta.signature=''; saveDraft(false);});

  function drawFromState(){
    if(!state.meta.signature) return; const img=new Image(); img.onload=()=>{ctx.drawImage(img,0,0,cvs.width,cvs.height)}; img.src=state.meta.signature;
  }
})();

// ====== 7) 保存と読み込み ======
function storageKey(){
  const c=(state.meta.client||'未設定').trim();
  const d=(state.meta.visitDate||'').trim();
  return `巡回監査:${c}:${d}`;
}
function saveDraft(showToast=true){
  localStorage.setItem(storageKey(), JSON.stringify(state));
  if(showToast) toast('保存しました');
}
function loadDraft(){
  const raw = localStorage.getItem(storageKey());
  if(!raw) return;
  try{ const obj = JSON.parse(raw); Object.assign(state, obj); }catch{}
}
function toast(msg){
  const t=document.createElement('div');
  t.textContent=msg; t.style.cssText='position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:#111827;color:#fff;padding:8px 12px;border-radius:999px;font-size:14px;opacity:.95;z-index:30';
  document.body.appendChild(t); setTimeout(()=>t.remove(),1500);
}

// メタの双方向
['client','visitDate','auditor','globalNote'].forEach(id=>{
  el(id).addEventListener('input',()=>{ state.meta[id]=el(id).value; saveDraft(false); });
});

// ====== 8) エクスポート ======
function download(filename, content, mime='application/json'){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}

function exportJSON(){
  const payload = { ...state, template:TEMPLATE, exportedAt:new Date().toISOString() };
  const name = `${state.meta.client||'未設定'}_${state.meta.visitDate||''}_巡回監査.json`;
  download(name, JSON.stringify(payload,null,2));
}

function exportCSV(){
  const rows = [["顧問先","監査日","担当者","セクション","項目ID","項目","状態","メモ","写真枚数"]];
  TEMPLATE.forEach(sec=>{
    sec.items.forEach(it=>{
      rows.push([
        state.meta.client||'', state.meta.visitDate||'', state.meta.auditor||'', sec.section, it.id, it.label,
        state.answers[it.id]||'', (state.notes[it.id]||'').replace(/\n/g,' '), (state.photos[it.id]||[]).length
      ]);
    })
  })
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const name = `${state.meta.client||'未設定'}_${state.meta.visitDate||''}_巡回監査.csv`;
  download(name, csv, 'text/csv');
}

// ====== 9) テンプレート編集 ======
function loadTemplateFromEditor(){
  try{
    const j = JSON.parse(el('tplEditor').value);
    if(!Array.isArray(j)) throw new Error('最上位は配列である必要があります');
    TEMPLATE = j; localStorage.setItem('巡回監査:TEMPLATE', JSON.stringify(TEMPLATE));
    render(); toast('テンプレートを読み込みました');
  }catch(err){ alert('テンプレート読込に失敗: '+err.message); }
}
function exportTemplate(){ download('巡回監査_テンプレート.json', JSON.stringify(TEMPLATE,null,2)); }
function resetTemplate(){ if(confirm('テンプレートを初期化しますか？')){ TEMPLATE = DEFAULT_TEMPLATE; localStorage.removeItem('巡回監査:TEMPLATE'); render(); } }

// ====== 10) 初期化 ======
(function init(){
  // 既存メタ復元
  el('templateVer').textContent = 'v1';
  // 今日の日付デフォルト
  const today = new Date();
  el('visitDate').value = new Date(today.getTime()-today.getTimezoneOffset()*60000).toISOString().slice(0,10);
  state.meta.visitDate = el('visitDate').value;
  // 既存ドラフト読込（顧問先未設定のままでもドラフトキーは作られます）
  loadDraft();
  // メタUIに反映
  ['client','visitDate','auditor','globalNote'].forEach(id=>{ if(state.meta[id]) el(id).value = state.meta[id]; });
  render();

  // ボタン
  el('save').onclick=()=>saveDraft();
  el('export').onclick=exportJSON;
  el('csv').onclick=exportCSV;
  el('print').onclick=()=>window.print();
  el('reset').onclick=()=>{ if(confirm('入力内容を全てクリアします。よろしいですか？')){ Object.assign(state,{answers:{},notes:{},photos:{},meta:{client:'',visitDate:'',auditor:'',globalNote:'',signature:''}}); localStorage.removeItem(storageKey()); render(); }}

  el('tplLoad').onclick=loadTemplateFromEditor;
  el('tplExport').onclick=exportTemplate;
  el('tplReset').onclick=resetTemplate;
})();
</script>
</body>
</html>
